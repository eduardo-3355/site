<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrinho - Royal essence</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos rápidos para o formulário de checkout */
    .checkout-panel {
      max-width: 600px;
      margin: 20px auto;
      background: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    .hidden { display: none; }

    .checkout-panel h3 {
      margin-bottom: 12px;
      color: #00aaff;
    }

    .form-row { margin-bottom: 10px; }
    .form-row label { display:block; font-size:0.95rem; margin-bottom:6px; }
    .form-row input {
      width:100%; padding:10px; border-radius:6px; border:1px solid #333; background:#222; color:#fff;
    }

    .form-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    .form-actions button { padding:10px 14px; border-radius:6px; border:none; cursor:pointer; }
    .btn-primary { background:#00aaff; color:#fff; }
    .btn-secondary { background:#333; color:#fff; }

    .order-success { background: #0a3; color: #022; padding:10px; border-radius:8px; margin-top:12px; }

    .pix-section {
      background: #fff; /* Fundo claro para facilitar escaneamento */
      color: #000;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .pix-section #qrcode {
      margin: 10px auto;
      max-width: 220px;
      padding: 10px;
      background: #fff;
    }

    /* Ajustes responsivos */
    @media (max-width: 480px) {
      .checkout-panel { margin: 10px; padding: 16px; }
      .form-actions { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <h1>Royal essence</h1>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">Início</a></li>
        <li><a href="perfumes.html">Perfumes</a></li>
        <li><a href="desodorantes.html">Desodorantes</a></li>
        <li><a href="sobre-nos.html">Sobre Nós</a></li>
        <li><a href="contato.html">Contato</a></li>
        <li><a href="carrinho.html">Carrinho (<span id="cart-count">0</span>)</a></li>
      </ul>
    </nav>
  </header>

  <!-- Carrinho Section -->
  <section class="cart">
    <h2>Seu Carrinho</h2>
    <div id="cart-items">
      <!-- Os itens do carrinho serão renderizados aqui via JavaScript -->
    </div>
    <div class="cart-total">
      <p>Total: R$ <span id="total-price">0,00</span></p>
      <button id="finalizar-btn" class="btn">Finalizar Compra</button>
    </div>
  </section>

  <!-- Checkout Panel (inicialmente escondido) -->
  <section id="checkout-section" class="checkout-panel hidden" aria-hidden="true">
    <h3>Finalizar Compra</h3>

    <form id="checkout-form" autocomplete="on">
      <div class="form-row">
        <label for="nome">Nome completo</label>
        <input type="text" id="nome" name="nome" required minlength="2" />
      </div>

      <div class="form-row">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required />
      </div>

      <div class="form-row">
        <label for="cpf">CPF</label>
        <input type="text" id="cpf" name="cpf" inputmode="numeric" placeholder="Apenas números" required maxlength="14" />
      </div>

      <div class="form-row">
        <label for="nascimento">Data de nascimento</label>
        <input type="date" id="nascimento" name="nascimento" required />
      </div>

      <div class="form-actions">
        <button type="button" id="cancel-checkout" class="btn-secondary">Cancelar</button>
        <button type="submit" class="btn-primary">Confirmar Pedido</button>
      </div>
    </form>

    <div id="order-message" class="hidden" role="status"></div>

    <!-- PIX Section -->
    <div id="pix-section" class="pix-section hidden">
      <h3>Pagamento via PIX</h3>
      <p>Use a chave abaixo para efetuar o pagamento:</p>
      <p><strong>Chave PIX:</strong> <span id="pix-key">11978315772</span></p>
      <div id="qrcode"></div>

      <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
        <button id="copy-pix" class="btn">Copiar chave PIX</button>
        <button id="download-qr" class="btn">Baixar QR Code</button>
      </div>

      <div style="margin-top:12px; text-align:left; font-size:0.95rem;">
        <strong>Como pagar (opções):</strong>
        <ol>
          <li>Copie a chave PIX e cole no campo "Chave" do seu app bancário (Pix &gt; Pagar).</li>
          <li>Ou baixe o QR Code e, no app do banco, escolha a opção de pagar por QR Code a partir da galeria/imagem.</li>
        </ol>
      </div>
      <p style="margin-top:8px;">Após a transferência, envie o comprovante para o email informado para agilizar a confirmação.</p>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 Luxury Scents. Todos os direitos reservados.</p>
  </footer>

  <!-- Biblioteca QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    let cart = [];

    function updateCartCount() {
      const cartCount = document.getElementById("cart-count");
      cartCount.textContent = cart.length;
    }

    function saveCartToLocalStorage() {
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    function loadCartFromLocalStorage() {
      const savedCart = JSON.parse(localStorage.getItem("cart"));
      if (Array.isArray(savedCart)) {
        cart = savedCart;
      } else {
        cart = [];
      }
      updateCartCount();
      renderCartItems();
    }

    function renderCartItems() {
      const cartItemsContainer = document.getElementById("cart-items");
      const totalPrice = document.getElementById("total-price");
      let total = 0;

      cartItemsContainer.innerHTML = "";

      if (cart.length === 0) {
        cartItemsContainer.innerHTML = '<p>Seu carrinho está vazio.</p>';
      }

      cart.forEach((item, idx) => {
        const itemElement = document.createElement("div");
        itemElement.classList.add("cart-item");

        itemElement.innerHTML = `
          <img src="${item.image}" alt="${item.name}" />
          <h3>${item.name}</h3>
          <p>R$ ${Number(item.price).toFixed(2)}</p>
          <button class="btn" onclick="removeFromCart(${idx})">Remover</button>
        `;
        cartItemsContainer.appendChild(itemElement);
        total += Number(item.price);
      });

      totalPrice.textContent = total.toFixed(2);
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartCount();
      saveCartToLocalStorage();
      renderCartItems();
    }

    const finalizarBtn = document.getElementById('finalizar-btn');
    const checkoutSection = document.getElementById('checkout-section');
    const cancelCheckout = document.getElementById('cancel-checkout');
    const checkoutForm = document.getElementById('checkout-form');
    const orderMessage = document.getElementById('order-message');
    const pixSection = document.getElementById('pix-section');
    const pixKeySpan = document.getElementById('pix-key');
    const copyPixBtn = document.getElementById('copy-pix');
    const downloadQrBtn = document.getElementById('download-qr');

    finalizarBtn.addEventListener('click', function() {
      if (cart.length === 0) {
        alert('Seu carrinho está vazio. Adicione produtos antes de finalizar a compra.');
        return;
      }
      showCheckout();
    });

    cancelCheckout.addEventListener('click', function() {
      hideCheckout();
    });

    function showCheckout() {
      checkoutSection.classList.remove('hidden');
      checkoutSection.setAttribute('aria-hidden', 'false');
      window.scrollTo({ top: checkoutSection.offsetTop - 20, behavior: 'smooth' });
    }

    function hideCheckout() {
      checkoutSection.classList.add('hidden');
      checkoutSection.setAttribute('aria-hidden', 'true');
      orderMessage.classList.add('hidden');
      orderMessage.textContent = '';
      pixSection.classList.add('hidden');
      checkoutForm.classList.remove('hidden');
    }

    function validarCPF(cpf) {
      const apenasDigitos = cpf.replace(/\D/g, '');
      return apenasDigitos.length === 11;
    }

    const cpfInput = document.getElementById('cpf');
    cpfInput && cpfInput.addEventListener('input', function(e) {
      let v = e.target.value.replace(/\D/g, '');
      if (v.length > 11) v = v.slice(0,11);
      v = v.replace(/(\d{3})(\d)/, '$1.$2');
      v = v.replace(/(\d{3})(\d)/, '$1.$2');
      v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = v;
    });

    function generateQRCodeForKey(key) {
      const qrcodeDiv = document.getElementById("qrcode");
      qrcodeDiv.innerHTML = "";
      new QRCode(qrcodeDiv, {
        text: key,
        width: 260,
        height: 260
      });
      setTimeout(() => {
        const img = qrcodeDiv.querySelector('img');
        if (img && img.src) {
          downloadQrBtn.disabled = false;
          downloadQrBtn.dataset.imgsrc = img.src;
        }
      }, 200);
    }

    copyPixBtn && copyPixBtn.addEventListener('click', function() {
      const key = pixKeySpan.textContent.trim();
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(key).then(() => {
          alert('Chave PIX copiada: ' + key);
        }).catch(() => {
          alert('Não foi possível copiar automaticamente. Selecione e copie manualmente: ' + key);
        });
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = key;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          alert('Chave PIX copiada: ' + key);
        } catch (e) {
          alert('Não foi possível copiar automaticamente. Selecione e copie manualmente: ' + key);
        }
        textarea.remove();
      }
    });

    downloadQrBtn && downloadQrBtn.addEventListener('click', function() {
      const imgSrc = this.dataset.imgsrc;
      if (!imgSrc) { alert('QR Code ainda não gerado. Confirme o pedido primeiro.'); return; }
      const a = document.createElement('a');
      a.href = imgSrc;
      a.download = 'pix-11978315772.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    checkoutForm.addEventListener('submit', function(event) {
      event.preventDefault();

      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const nascimento = document.getElementById('nascimento').value;

      if (!nome || nome.length < 2) { alert('Informe um nome válido.'); return; }
      if (!email || !/.+@.+\..+/.test(email)) { alert('Informe um email válido.'); return; }
      if (!validarCPF(cpf)) { alert('Informe um CPF válido (11 dígitos).'); return; }
      if (!nascimento) { alert('Informe a data de nascimento.'); return; }

      const pedido = {
        id: 'PED' + Date.now(),
        nome,
        email,
        cpf: cpf.replace(/\D/g, ''),
        nascimento,
        itens: cart,
        total: Number(document.getElementById('total-price').textContent),
        criadoEm: new Date().toISOString()
      };

      const existingOrders = JSON.parse(localStorage.getItem('orders') || '[]');
      existingOrders.push(pedido);
      localStorage.setItem('orders', JSON.stringify(existingOrders));

      cart = [];
      saveCartToLocalStorage();
      updateCartCount();
      renderCartItems();

      orderMessage.classList.remove('hidden');
      orderMessage.classList.add('order-success');
      orderMessage.textContent = `Pedido ${pedido.id} confirmado! Enviaremos a confirmação para ${email}.`;

      checkoutForm.classList.add('hidden');
      pixSection.classList.remove('hidden');

      const key = pixKeySpan.textContent.trim();
      generateQRCodeForKey(key);
    });

    document.addEventListener("DOMContentLoaded", function() {
      loadCartFromLocalStorage();

      document.querySelectorAll('.btn').forEach(button => {
        if (!button.id || button.id !== 'finalizar-btn') {
          button.addEventListener('click', function() {
            const inCartArea = this.closest('.cart');
            if (!inCartArea) alert('Produto adicionado ao carrinho!');
          });
        }
      });
    });
  </script>
</body>
</html>